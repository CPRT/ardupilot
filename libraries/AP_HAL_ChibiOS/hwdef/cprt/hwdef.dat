# hw definition file for processing by chibios_hwdef.py

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID. See Tools/AP_Bootloader/board_types.txt
APJ_BOARD_ID AP_HW_MATEKH743

# crystal frequency
OSCILLATOR_HZ 16000000

# ChibiOS system timer
STM32_ST_USE_TIMER 5

# Now the size of flash in kilobytes, for creating the ld.script.

# flash size
FLASH_SIZE_KB 2048

FLASH_RESERVE_START_KB 128

# order of I2C buses
I2C_ORDER I2C1 I2C4 I2C2

# Now the serial ordering. These map to the SERIALn_ parameter numbers
# If you use a shorter list then HAL_Empty::UARTDriver
# objects are substituted for later UARTs, or you can leave a gap by
# listing one or more of the uarts as EMPTY.

# The normal usage of this ordering is:
# 1) SERIAL0: console (primary mavlink, usually USB)
# 2) SERIAL1: telem1
# 3) SERIAL2: telem2
# 4) SERIAL3: primary GPS
# 5) SERIAL4: GPS2
# 6) SERIAL5: extra UART (usually RTOS debug console)

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART2 UART4 USART3 UART7 UART5

# UART
PC10 UART4_TX UART4
PC11 UART4_RX UART4
PC12 UART5_TX UART5
PB12 UART5_RX UART5

# Now the VDD sense pin. This is used to sense primary board voltage.
PC0 VDD_5V_SENS ADC1 SCALE(2)

# Now the first SPI bus. At minimum you need SCK, MISO and MOSI pin
# definitions. You can add speed modifiers if you want them, otherwise
# the defaults for the peripheral class are used.

PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1

# Now we define the pins that USB is connected on.
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# These are the pins for SWD debugging with a STlinkv2 or black-magic probe.
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# This defines a couple of general purpose outputs, mapped to GPIO
# numbers 1 and 2 for users.
PB0 EXTERN_GPIO1 OUTPUT GPIO(1)
PB1 EXTERN_GPIO2 OUTPUT GPIO(2)

# This defines the pins for the 2nd CAN interface, if available.
PB6 CAN2_TX CAN2
PB5 CAN2_RX CAN2

# Now the first I2C bus. The pin speeds are automatically setup
# correctly, but can be overridden here if needed.
PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# the 2nd I2C bus
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

PD12 I2C4_SCL I2C4
PD13 I2C4_SDA I2C4

# the 2nd SPI bus
PB13 SPI2_SCK SPI2
PC2 SPI2_MISO SPI2
PC3 SPI2_MOSI SPI2
PE15 EXT_CS CS

PE3 IMU1_CS CS
PC4 IMU2_CS CS

# the first CAN bus
PD0  CAN1_RX CAN1
PD1  CAN1_TX CAN1

# Another USART, this one for telem1. This one has RTS and CTS lines.
# USART2 serial2 telem1
PD3 USART2_CTS USART2
PD4 USART2_RTS USART2
PD5 USART2_TX USART2
PD6 USART2_RX USART2

# The telem2 USART, also with RTS/CTS available.
# USART3 serial3 telem2
PD8 USART3_TX USART3
PD9 USART3_RX USART3

# The CS pin for FRAM (ramtron). This one is marked as using
# SPEED_VERYLOW, which matches the HAL_PX4 setup.
PA4 FRAM_CS CS SPEED_VERYLOW

# Now we start defining some PWM pins. We also map these pins to GPIO
# values, so users can set BRD_PWM_COUNT to choose how many of the PWM
# outputs on the primary MCU are setup as PWM and how many as
# GPIOs. To match HAL_PX4 we number the GPIOs for the PWM outputs
# starting at 50.

PA9  TIM1_CH2 TIM1 PWM(1) GPIO(50)
PA8  TIM1_CH1 TIM1 PWM(2) GPIO(51)
PC9 TIM3_CH4 TIM3 PWM(3) GPIO(52)
PC8 TIM3_CH3 TIM3 PWM(4) GPIO(53)
PC7 TIM3_CH2 TIM3 PWM(5) GPIO(54)
PC6 TIM3_CH1 TIM3 PWM(6) GPIO(55)
PD15 TIM4_CH4 TIM4 PWM(7) GPIO(56)
PD14 TIM4_CH3 TIM4 PWM(8) GPIO(57)

# Now setup SPI bus4.
PE2 SPI4_SCK  SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4

PE0 VDD_3V3_SENSORS_EN OUTPUT LOW

# UART7 maps to SERIAL5.
PE7 UART7_RX UART7
PE8 UART7_TX UART7
PE9 UART7_RTS UART7
PE10 UART7_CTS UART7

# microSD support
PB14 SDMMC2_D0 SDMMC2
PB15 SDMMC2_D1 SDMMC2
PC1 SDMMC2_CK SDMMC2
PB3 SDMMC2_D2 SDMMC2
PB4 SDMMC2_D3 SDMMC2
PD7 SDMMC2_CMD SDMMC2
define FATFS_HAL_DEVICE SDCD2

# RGB LED
PA2 LED_RED OUTPUT OPENDRAIN GPIO(90) HIGH
PA3 LED_GREEN OUTPUT OPENDRAIN GPIO(91) HIGH
PA1 LED_BLUE OUTPUT OPENDRAIN GPIO(92) HIGH

define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 90
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 91
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 92

define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1

# The DEVID values and device names are chosen to match the PX4 port
# of ArduPilot so users don't need to re-do their accel and compass
# calibrations when moving to ChibiOS.

SPIDEV icm45686       SPI4 DEVID1  IMU1_CS     MODE3  2*MHZ  8*MHZ
SPIDEV icm45686-2     SPI1 DEVID1  IMU2_CS     MODE3  2*MHZ  8*MHZ
SPIDEV ramtron        SPI1 DEVID10 FRAM_CS     MODE3  8*MHZ  8*MHZ

# Sensor definitions

BARO ICP201XX I2C:0:0x63
BARO ICP201XX I2C:2:0x63

COMPASS LIS2MDL I2C:2:0x1E false ROTATION_NONE

IMU Invensensev3 SPI:icm45686 ROTATION_PITCH_180_YAW_90
IMU Invensensev3 SPI:icm45686-2 ROTATION_PITCH_180

define HAL_INS_HIGHRES_SAMPLE 7
define HAL_DEFAULT_INS_FAST_SAMPLE 7

define HAL_BATTMON_INA2XX_BUS 1
define HAL_BATTMON_INA2XX_ADDR 0

# We need to tell HAL_ChibiOS/Storage.cpp how much storage is
# available (in bytes).
define HAL_STORAGE_SIZE 32768

# allow to have have a dedicated safety switch pin
define HAL_HAVE_SAFETY_SWITCH 1

# Enable RAMTRON parameter storage.
define HAL_WITH_RAMTRON 1

# Enable FAT filesystem support (needs a microSD defined via SDIO).
define HAL_OS_FATFS_IO 1
